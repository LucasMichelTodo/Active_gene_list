#+STARTUP: hideblocks
#+PROPERTY: header-args :eval never-export
#+OPTIONS: ^:{}

#+SETUPFILE: /home/lucas/org-html-themes-master/org/theme-readtheorg-local.setup
#+HTML_HEAD: <style>pre.src {background-color: #3F3F3F ; color: #e5e5e5;}</style>

#+TITLE:  Creation of active gene-lists
#+AUTHOR: Lucas Michel Tod√≥
#+EMAIL:  lucas.michel@isglobal.org
#+DATE:   31/03/2020

* Active/Inactive Gene lists
:PROPERTIES:
:header-args:R: :session active_gene_lists
:header-args:R+: :exports results
:header-args:R+: :results output
:END:

Our aim is to create a unified table that assigns to each gene in the P.falicparum gnome a expresion state.
We will define 6 possible expresion states:

- Active
  - Active (no-variant genes)
  - Variant Active
  - Variant Semiactive (vairant genes with an intermediate state)

- Inactive
  - Inactive (no-variant genes)
  - Variant Repressed

- Not-Settable

** Microarray Data: Red Signal
We willl load the red signal and transform it into percentiles. For each gene we pick the "Aver.2Higher" column from the original microarrays data table. This column corresponds to the average between the two highest red signals among available timepoints.

Red Signal DataFrame
#+BEGIN_SRC R
head(as.data.frame(red_df))
#+END_SRC

#+RESULTS:
#+begin_example
        Gene_id     Red_12B     Red_10G   Red_3D7B Percent_12B Percent_10G
1    mal_mito_3 22579.33333 36436.73333 30636.8250  96.0466005  98.4721161
2 PF3D7_0100100   104.17083   215.03542   264.4000   5.6913675  10.9625668
3 PF3D7_0100200  1357.70000    72.67917   724.1500  29.7555386   4.0106952
4 PF3D7_0100300   283.98333   291.69583  7540.9042  12.5668449  12.9870130
5 PF3D7_0100400   193.77500    35.01250   161.0833   9.8930481   1.0504202
6 PF3D7_0100600    31.58333    33.40417    31.5250   0.2291826   0.4392666
  Percent_3D7B MaxRedPercentDif MeanRedPercent MaxRedPercent
1   97.8800611         2.425516     97.4662592    98.4721161
2   11.1153552         5.423988      9.2564298    11.1153552
3   19.9006875        25.744843     17.8889738    29.7555386
4   81.3407181        68.773873     35.6315253    81.3407181
5    8.0595875         8.842628      6.3343519     9.8930481
6    0.2387319         0.210084      0.3023937     0.4392666
#+end_example

** Microarray Data: Areas
We will load the areas data to calculate FC among strains. For each gene, we select the time interval (right, left, mid or sides) for which we find the maximum difference among strains (between highest and lowest). We will also add a column to check if this time interval corresponds to the interval of maxium expression for each strain.

Areas DataFrame
#+BEGIN_SRC R
head(as.data.frame(area_df))
#+END_SRC

#+RESULTS:
#+begin_example
              Gene_id     l_12B     r_12B     m_12B    s_12B     l_10G    r_10G
1          mal_mito_3 30.592496 61.080128 49.676556 41.99607 25.372470 62.38873
2 MAL13P1.415_oldname  5.423269  8.488971  1.289779 12.62246  6.117132 10.59524
3  MAL13P1.65_oldname 18.322430        NA 17.593468       NA 14.071128       NA
4  MAL7P1.142_oldname  9.389247 12.807814 10.340803 11.85626 13.661078 14.52676
5  MAL8P1.310_oldname        NA        NA        NA       NA        NA       NA
6   MAL8P1.90_oldname        NA        NA        NA       NA        NA       NA
      m_10G    s_10G    l_3D7B   r_3D7B    m_3D7B    s_3D7B   MaxLeft   MinLeft
1 49.805504 37.95570 25.484634 62.83441 50.462696 37.856349 30.592496 25.372470
2  3.676218 13.03616  1.789873 10.51234  3.691753  8.610459  6.117132  1.789873
3        NA       NA 19.333324       NA        NA        NA 19.333324 14.071128
4 13.401610 14.78623  7.099032 13.34518 12.041177  8.403034 13.661078  7.099032
5        NA       NA        NA       NA        NA        NA        NA        NA
6        NA       NA        NA       NA        NA        NA        NA        NA
  MaxRight  MinRight    MaxMid    MinMid MaxSides  MinSides  DifLeft DifRight
1 62.83441 61.080128 50.462696 49.676556 41.99607 37.856349 5.220025 1.754283
2 10.59524  8.488971  3.691753  1.289779 13.03616  8.610459 4.327259 2.106274
3       NA        NA        NA        NA       NA        NA 5.262196       NA
4 14.52676 12.807814 13.401610 10.340803 14.78623  8.403034 6.562046 1.718950
5       NA        NA        NA        NA       NA        NA       NA       NA
6       NA        NA        NA        NA       NA        NA       NA       NA
     DifMid DifSides Interval   MaxDif    areaFC  area_12B area_10G area_3D7B
1 0.7861401 4.139719     Left 5.220025 0.3881060 30.592496 25.37247 25.484634
2 2.4019733 4.425700    Sides 4.425700 0.3290483 12.622460 13.03616  8.610459
3        NA       NA     Left 5.262196 0.3912413 18.322430 14.07113 19.333324
4 3.0608067 6.383199     Left 6.562046 0.4878845  9.389247 13.66108  7.099032
5        NA       NA  No Data       NA        NA        NA       NA        NA
6        NA       NA  No Data       NA        NA        NA       NA        NA
   MaxArea   MinArea
1 30.59250 25.372470
2 13.03616  8.610459
3 19.33332 14.071128
4 13.66108  7.099032
5       NA        NA
6       NA        NA
#+end_example

** Load RNA-Seq Data
We will use publicly available data from PlasmoDB to create a reference expresion percentile for each gene.
All data-sets are from RNA-Seq studies in the 3D7 strain.
We are using 4 different data-sets:
- Otto et.al.
- Hoeijmakers et.al.
- Toenhake et.al.
- Bartfai et.al.

We use only uniquely mapped reads and scaled data when available.
For each Data-Set we first create a column representing the maxium value among timepoints for each gene. We then convert this column into percentile values. Finally we average this percentile values among all Data-Sets.


RNA-Seq DataFrame
#+BEGIN_SRC R
head(as.data.frame(rna_df))
#+END_SRC

#+RESULTS:
#+begin_example
        Gene_id Otto_Max_pcnt Hoeij_Max_pcnt Toen_Max_pcnt Bart_Max_pcnt
1    mal_mito_1     97.695933      66.259382      69.20929     80.520161
2    mal_mito_2     98.079944      88.776401      85.12829     94.728574
3    mal_mito_3     97.835573      92.249956      89.99825     90.190260
4 PF3D7_0100100     26.104032      24.855996      17.57724     18.240531
5 PF3D7_0100200      7.366032      25.693838      13.83313     18.764182
6 PF3D7_0100300     22.045732       3.587013       2.46989      1.885146
  MeanPercent StdDevPercent
1   78.421190     12.335823
2   91.678303      5.040060
3   92.568511      3.166454
4   21.694449      3.818402
5   16.414296      6.711285
6    7.496945      8.421970
#+end_example

We plot the resulting distribution of percentiles (it should be almost flat).
#+BEGIN_SRC R :file ./Plots/rnaseq_perc.png :exports results :results output graphics
p <- ggplot(rna_df, aes(x=MeanPercent)) +
  geom_histogram(bins = 20) +
  ggtitle("Mean Percentile among Data-Sets")

print(p)
#+END_SRC

#+RESULTS:
[[file:./Plots/rnaseq_perc.png]]


We plot the standard deviation of the percentile values among different Data-Sets and we can see that for the vast majority of genes it doesn't go above 10.
#+BEGIN_SRC R :file ./Plots/rnaseq_perc_sd.png :exports results :results output graphics
p <- ggplot(rna_df, aes(x=StdDevPercent)) +
  geom_histogram(bins = 100) +
  ggtitle("SD of Percent value (among different studies)")

print(p)
#+END_SRC

#+RESULTS:
[[file:./Plots/rnaseq_perc_sd.png]]
** Create table for classification

Joining and summarizing all the prevoius data we create a a table that will let us classify the genes according to their expression state.

To classify genes, we add a colum for each strain were we classify genes according to their expression relative to other strains.
To create this column we have taken the maximum and minimum area value for each gene and divided this interval in 3 equal regions. Each strain then gets a value of man/mid/max according to which region it falls.

~gene-min----|---mid----|----gene-max~

Final DataFrame
#+BEGIN_SRC R
## NA's dont print well when in a "character" col.
x <- final_df %>%
  replace_na(list(rel_12B = "NA", rel_10G = "NA", rel_3D7B = "NA"))

head(as.data.frame(x))
#+END_SRC

#+RESULTS:
#+begin_example

        Gene_id Variant Percent_12B Percent_10G Percent_3D7B MaxRedPercentDif
1    mal_mito_3   FALSE  96.0466005  98.4721161   97.8800611         2.425516
2 PF3D7_0100100    TRUE   5.6913675  10.9625668   11.1153552         5.423988
3 PF3D7_0100200    TRUE  29.7555386   4.0106952   19.9006875        25.744843
4 PF3D7_0100300    TRUE  12.5668449  12.9870130   81.3407181        68.773873
5 PF3D7_0100400    TRUE   9.8930481   1.0504202    8.0595875         8.842628
6 PF3D7_0100600    TRUE   0.2291826   0.4392666    0.2387319         0.210084
  MeanRedPercent MaxRedPercent Interval    areaFC area_12B  area_10G area_3D7B
1     97.4662592    98.4721161     Left 0.3881060 30.59250 25.372470  25.48463
2      9.2564298    11.1153552     Left 0.8879945 31.76998 43.713503  38.29839
3     17.8889738    29.7555386    Right 3.5015562 52.33320  5.237266  43.02460
4     35.6315253    81.3407181     Left 3.3957657 31.78908 33.073957  77.46213
5      6.3343519     9.8930481     Left 2.0671154 23.21846  7.706832  35.50954
6      0.3023937     0.4392666  No Data        NA       NA        NA        NA
   MaxArea   MinArea MeanPercent rel_12B rel_10G rel_3D7B Gene_name
1 30.59250 25.372470   92.568511     max     min      min      null
2 43.71350 31.769976   21.694449     min     max      mid       VAR
3 52.33320  5.237266   16.414296     max     min      max       RIF
4 77.46213 31.789080    7.496945     min     min      max       VAR
5 35.50954  7.706832   14.607698     mid     min      max       RIF
6       NA        NA    4.789230      NA      NA       NA       RIF
                                   Annot
1                    unspecified product
2 erythrocyte membrane protein 1, PfEMP1
3                                  rifin
4 erythrocyte membrane protein 1, PfEMP1
5                                  rifin
6                                  rifin
#+end_example

** Create Lists according to thresholds

Now that we have all the data loaded in, we can star to set labels for each gene.

We have set the following thresholds:
- (rna_pcnt) RNA-Seq mean percentile: 25%
- (red_pcnt) Red Signal Percentile (by sample): 25%
- (red_rescue) Red Signal Mean Percentile for "rescuing": 40%
- (area_fc) Area log2 Fold-Change: 1

In addition to these thresholds we will use 2 more columns to set the categories:
- Variant: a column stating if gene is variant/non-variant
- Relative Expression (by strain): a colum were each gene is set to min/mid/max according to it's expression level relative to the other strains.

We will have the following categories with the following logic:

[[./Plots/Decision_Tree.jpg]]

[[./Plots/Decision_Tree.jpg][Make bigger]]


Genes that have NA values in any of the classification columns are classified according to the following tree.
[[file:./Plots/active_genes_NAs.jpg]]

[[file:Plots/active_genes_NAs.jpg][Make bigger]]

Using this criteria we construct the following DataFrame:

Gene-State DataFrame
#+BEGIN_SRC R
x <- state_df %>%
  replace_na(list(rel_12B = "NA", rel_10G = "NA", rel_3D7B = "NA"))

head(as.data.frame(x))
#+END_SRC

#+RESULTS:
#+begin_example

        Gene_id Variant Percent_12B Percent_10G Percent_3D7B MaxRedPercentDif
1    mal_mito_3   FALSE  96.0466005  98.4721161   97.8800611         2.425516
2 PF3D7_0100100    TRUE   5.6913675  10.9625668   11.1153552         5.423988
3 PF3D7_0100200    TRUE  29.7555386   4.0106952   19.9006875        25.744843
4 PF3D7_0100300    TRUE  12.5668449  12.9870130   81.3407181        68.773873
5 PF3D7_0100400    TRUE   9.8930481   1.0504202    8.0595875         8.842628
6 PF3D7_0100600    TRUE   0.2291826   0.4392666    0.2387319         0.210084
  MeanRedPercent MaxRedPercent Interval    areaFC area_12B  area_10G area_3D7B
1     97.4662592    98.4721161     Left 0.3881060 30.59250 25.372470  25.48463
2      9.2564298    11.1153552     Left 0.8879945 31.76998 43.713503  38.29839
3     17.8889738    29.7555386    Right 3.5015562 52.33320  5.237266  43.02460
4     35.6315253    81.3407181     Left 3.3957657 31.78908 33.073957  77.46213
5      6.3343519     9.8930481     Left 2.0671154 23.21846  7.706832  35.50954
6      0.3023937     0.4392666  No Data        NA       NA        NA        NA
   MaxArea   MinArea MeanPercent rel_12B rel_10G rel_3D7B Gene_name
1 30.59250 25.372470   92.568511     max     min      min      null
2 43.71350 31.769976   21.694449     min     max      mid       VAR
3 52.33320  5.237266   16.414296     max     min      max       RIF
4 77.46213 31.789080    7.496945     min     min      max       VAR
5 35.50954  7.706832   14.607698     mid     min      max       RIF
6       NA        NA    4.789230      NA      NA       NA       RIF
                                   Annot                  state_12B
1                    unspecified product                     Active
2 erythrocyte membrane protein 1, PfEMP1         Var_Repressed_noFC
3                                  rifin              Var_Active_FC
4 erythrocyte membrane protein 1, PfEMP1 Var_Repressed_FC_noredpcnt
5                                  rifin Var_Repressed_FC_noredpcnt
6                                  rifin         Var_Repressed_FCna
                   state_10G                 state_3D7B  category_12B
1                     Active                     Active        Active
2         Var_Repressed_noFC         Var_Repressed_noFC Var_Repressed
3 Var_Repressed_FC_noredpcnt Var_Repressed_FC_noredpcnt    Var_Active
4 Var_Repressed_FC_noredpcnt              Var_Active_FC Var_Repressed
5 Var_Repressed_FC_noredpcnt Var_Repressed_FC_noredpcnt Var_Repressed
6         Var_Repressed_FCna         Var_Repressed_FCna Var_Repressed
   category_10G category_3D7B
1        Active        Active
2 Var_Repressed Var_Repressed
3 Var_Repressed Var_Repressed
4 Var_Repressed    Var_Active
5 Var_Repressed Var_Repressed
6 Var_Repressed Var_Repressed
#+end_example

** Some results
This is a table with the number of genes in each state for each strain.

States Table
#+begin_src R
as.data.frame(state_table)
#+end_src

#+RESULTS:
#+begin_example
  Strain Active Active_FC Active_FC_Dif_max Active_FCna Active_FCna_Redna
1    12B   3944        20                 2           1               191
2    10G   3944        20                 2           1               191
3   3D7B   3944        20                 2           1               191
  Active_rescued Active_RNASeqNA_rescue Inactive Inactive_FC
1             53                      6      660          36
2             53                      6      660          36
3             53                      6      660          36
  Inactive_FC_Dif_min Inactive_FC_reddown Inactive_FCna Inactive_FCna_Redna
1                   2                   5            30                  89
2                   2                   5            30                  89
3                   2                   5            30                  89
  Inactive_reddown Not_Settable Var_Active_FC Var_Active_noFC
1               36          152             8              52
2               36          152             7              52
3               36          152            58              52
  Var_Active_noFC_rescued Var_Active_RNASeqNA_rescue Var_Repressed_FC
1                       3                          1                7
2                       3                          1                5
3                       3                          1                3
  Var_Repressed_FC_noredpcnt Var_Repressed_FCna Var_Repressed_noFC
1                        137                 92                128
2                        141                 92                128
3                         92                 92                128
  Var_Repressed_noFC_reddown Var_Semiactive_FC
1                          4                 1
2                          4                NA
3                          4                NA
#+end_example

And this are the Clag genes
#+begin_src R
as.data.frame(clags)
#+end_src

#+RESULTS:
#+begin_example
        Gene_id Variant Percent_12B Percent_10G Percent_3D7B MaxRedPercentDif
1 PF3D7_0302200    TRUE    78.68602    99.57983     42.32238         57.25745
2 PF3D7_0302500    TRUE    98.81589    84.39649     98.98778         14.59129
  MeanRedPercent MaxRedPercent Interval   areaFC  area_12B area_10G area_3D7B
1       73.52941      99.57983    Right 4.823089  37.32948 88.19577  23.32522
2       94.06672      98.98778    Right 3.452270 100.12065 53.68762  99.58767
    MaxArea  MinArea MeanPercent rel_12B rel_10G rel_3D7B Gene_name
1  88.19577 23.32522    76.36804     min     max      min   CLAG3.2
2 100.12065 53.68762    88.72404     max     min      max   CLAG3.1
                                     Annot        state_12B        state_10G
1 cytoadherence linked asexual protein 3.2 Var_Repressed_FC    Var_Active_FC
2 cytoadherence linked asexual protein 3.1    Var_Active_FC Var_Repressed_FC
        state_3D7B  category_12B  category_10G category_3D7B
1 Var_Repressed_FC Var_Repressed    Var_Active Var_Repressed
2    Var_Active_FC    Var_Active Var_Repressed    Var_Active
#+end_example

** Venn Diagrams
Here we plon Venn diagrams to visualize how the strains compare.

First we check how many genes share the same "state" among strains:

[[file:./Plots/venn_Same_State.png]]

Then we make venn diagrams for the "Var_active" and "Var_Repressed" states.

[[file:./Plots/venn_Var_Active_Genes.png]]

[[file:./Plots/venn_Var_Repressed_Genes.png]]

* Code
:PROPERTIES:
:header-args:R: :session active_gene_lists
:header-args:R+: :tangle ./Scripts/active_gene_list.R
:header-args:R+: :results none
:END:

** Load Packages and functions
#+BEGIN_SRC R :results none
#### Imports ####

library(readxl)
library(tidyverse)
library(eulerr)

#### Max Dif function ####

max_dif <- function(vect){
  mx <- max(vect, na.rm = T)
  mn <- min(vect, na.rm = T)
  if (is.infinite(mx) | is.infinite(mn)) {
    md <- NA
  } else {
    md <- mx - mn
  }
  return(md)
}

myMax <- function(x){
  if (all(is.na(x))){
    out <- NA
  } else {
    out <- max(x, na.rm=T)
  }
  return(out)
}

myMin <- function(x){
  if (all(is.na(x))){
    out <- NA
  } else {
    out <- min(x, na.rm=T)
  }
  return(out)
}

ave2higher <- function(vect){
  return(mean(sort(vect, decreasing = TRUE)[1:2]))
}
#+END_SRC

** Microarray Data: Red Signal

#+BEGIN_SRC R :results none
#### Red Signal DF ####

## Read translation table
map <- read.csv('./Data/oldnames_table.csv', stringsAsFactors = F)
excl <- "./Data/3D7_Variantome_AllData_withGam.xls"

## Import Red Signal table
red <- read_excel(excl, sheet = 4)

colnames(red)[1] <- "Old_id"

red_df <- red %>%
  select(Old_id,
         Red_12B = `Aver.2Higher1.2B.`,
         Red_10G = `Aver.2Higher10G.`,
         Red_3D7B = `Aver.2Higher3D7-B.`) %>%
  left_join(map, by='Old_id')

## Add new arrays

new_fld <- '/mnt/Disc4T/Projects/PhD_Project/Microarrays/New_Old_separate_approach/New_Arrays/R_results_NewArray/'

## Add B11

B11_red <- read_csv(paste0(new_fld, 'geneLevel_redSignal_exp.csv')) %>%
  select(Gene_id, contains('B11')) %>%
  mutate(across(contains('B11'), function(x) 2**x)) %>%
  mutate(Red_B11 = apply(select(., contains('tp')), 1, ave2higher))

## Add A7

A7_red <- read_csv(paste0(new_fld, 'geneLevel_redSignal_exp.csv')) %>%
  select(Gene_id, contains('A7')) %>%
  mutate(across(contains('A7'), function(x) 2**x)) %>%
  mutate(Red_A7 = apply(select(., contains('tp')), 1, ave2higher))

## Add E5

E5_red <- read_csv(paste0(new_fld, 'geneLevel_redSignal_exp.csv')) %>%
  select(Gene_id, contains('E5')) %>%
  mutate(across(contains('E5'), function(x) 2**x)) %>%
  mutate(Red_E5 = apply(select(., contains('tp')), 1, ave2higher))

## Manually add gene ids that do not appear on map (we blasted the probes to assign them)
red_df <- red_df %>%
  mutate(Gene_id = ifelse(Old_id == 'MAL8P1.310', 'PF3D7_0830200', Gene_id)) %>%
  mutate(Gene_id = ifelse(Old_id == 'PFI0905W', 'PF3D7_0918500', Gene_id)) %>%
  mutate(Gene_id = ifelse(Old_id == 'PFL1580W', 'PF3D7_1232700', Gene_id))

## Collapse gene ids that appear more than once (mean expression)
red_df <- red_df %>%
  select(-Old_id) %>%
  group_by(Gene_id) %>% summarize_all(list(mean))

## Filter out rows with untranslated gene ids (marked by '_oldname')
red_df <- red_df %>%
  filter(!grepl('_oldname', Gene_id))

## Join new Arrays

red_df <- red_df %>%
  left_join(B11_red %>% select(Gene_id, Red_B11)) %>%
  left_join(A7_red %>% select(Gene_id, Red_A7)) %>%
  left_join(E5_red %>% select(Gene_id, Red_E5))

## Transform into percentiles

red_df <- red_df %>%
  mutate(Percent_12B = (rank(Red_12B)/length(Red_12B))*100) %>%
  mutate(Percent_10G = (rank(Red_10G)/length(Red_10G))*100) %>%
  mutate(Percent_3D7B = (rank(Red_3D7B)/length(Red_3D7B))*100) %>%
  mutate(Percent_B11 = (rank(Red_B11)/length(Red_B11))*100) %>%
  mutate(Percent_A7 = (rank(Red_A7)/length(Red_A7))*100) %>%
  mutate(Percent_E5 = (rank(Red_E5)/length(Red_E5))*100)

print(red_df) %>% print(width = 400)

## Add max percentile dif

red_df <- red_df %>%
  mutate(MaxRedPercentDif = apply(select(., contains('Percent_')), 1, max_dif)) %>%
  mutate(MeanRedPercent = apply(select(., contains('Percent_')), 1, mean)) %>%
  mutate(MaxRedPercent = apply(select(., contains('Percent_')), 1, myMax))

print(red_df, width = 200)
hist(red_df$MeanRedPercent)

#+END_SRC
** Microarray Data: Areas
*** No Normalitzation
#+begin_src R :results none
#### Areas DF ####

# Import Areas table

area <- read_excel(excl, sheet = 2)

colnames(area)[1] <- "Old_id"

area_df <- area %>%
  select(Old_id,
         l_12B = `left.1.2b`,
         r_12B = `right.1.2b`,
         m_12B = `mid.1.2b`,
         s_12B = `sides.1.2b`,
         l_10G = `left.10g`,
         r_10G = `right.10g`,
         m_10G = `mid.10g`,
         s_10G = `sides.10g`,
         l_3D7B = `left.3d7b`,
         r_3D7B = `right.3d7b`,
         m_3D7B = `mid.3d7b`,
         s_3D7B = `sides.3d7b`) %>%

  mutate_at(vars(-Old_id), as.numeric) %>%


  left_join(map, by='Old_id') %>%
  select(-Old_id) %>%
  group_by(Gene_id) %>% summarize_all(list(mean))

## Add New arrays
B11_area <- read_csv(paste0(new_fld, 'area_geneLevel.csv')) %>%
  select(Gene_id, contains('B11')) %>%
  set_names(c('Gene_id', 'l_B11', 'r_B11', 'm_B11', 's_B11'))

A7_area <- read_csv(paste0(new_fld, 'area_geneLevel.csv')) %>%
  select(Gene_id, contains('A7')) %>%
  set_names(c('Gene_id', 'l_A7', 'r_A7', 'm_A7', 's_A7'))

E5_area <- read_csv(paste0(new_fld, 'area_geneLevel.csv')) %>%
  select(Gene_id, contains('E5')) %>%
  set_names(c('Gene_id', 'l_E5', 'r_E5', 'm_E5', 's_E5'))

area_df <- area_df %>%
  left_join(B11_area) %>%
  left_join(A7_area) %>%
  left_join(E5_area)

## Get Max and Min
print(area_df, width = 200)

area_df <- area_df %>%
  mutate(MaxLeft = apply(select(., contains('l_')), 1, myMax)) %>%
  mutate(MinLeft = apply(select(., contains('l_')), 1, myMin)) %>%

  mutate(MaxRight = apply(select(., contains('r_')), 1, myMax)) %>%
  mutate(MinRight = apply(select(., contains('r_')), 1, myMin)) %>%

  mutate(MaxMid = apply(select(., contains('m_')), 1, myMax)) %>%
  mutate(MinMid = apply(select(., contains('m_')), 1, myMin)) %>%

  mutate(MaxSides = apply(select(., contains('s_')), 1, myMax)) %>%
  mutate(MinSides = apply(select(., contains('s_')), 1, myMin)) %>%

  mutate(DifLeft = MaxLeft - MinLeft) %>%
  mutate(DifRight = MaxRight - MinRight) %>%
  mutate(DifMid = MaxMid - MinMid) %>%
  mutate(DifSides = MaxSides - MinSides)

print(area_df, width = 200)

## Add max interval and difference

maxinterval <- area_df %>%
  select(Gene_id, contains('Dif')) %>%
  pivot_longer(-Gene_id, names_to = 'Interval', values_to = 'MaxDif') %>%
  group_by(Gene_id) %>%
  filter(rank(-MaxDif, ties.method = "first") == 1) %>%
  mutate(Interval = ifelse(is.na(MaxDif), 'No Data', Interval)) %>%
  mutate(Interval = case_when(Interval == 'DifLeft' ~ 'Left',
                              Interval == 'DifRight' ~ 'Right',
                              Interval == 'DifMid' ~ 'Mid',
                              Interval == 'DifSides' ~ 'Sides',
                              Interval == 'No Data' ~ 'No Data')) %>%
  mutate(areaFC = MaxDif/13.45)

maxinterval

area_df <- area_df %>%
  left_join(maxinterval, by = 'Gene_id')

print(area_df, width = 400)

## Select appropiate area for each gene and add max and min areas

area_df <- area_df %>%
  mutate(area_12B = case_when(
           Interval == 'Left' ~ l_12B,
           Interval == 'Right' ~ r_12B,
           Interval == 'Mid' ~ m_12B,
           Interval == 'Sides' ~ s_12B,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_10G = case_when(
           Interval == 'Left' ~ l_10G,
           Interval == 'Right' ~ r_10G,
           Interval == 'Mid' ~ m_10G,
           Interval == 'Sides' ~ s_10G,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_3D7B = case_when(
           Interval == 'Left' ~ l_3D7B,
           Interval == 'Right' ~ r_3D7B,
           Interval == 'Mid' ~ m_3D7B,
           Interval == 'Sides' ~ s_3D7B,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_B11 = case_when(
           Interval == 'Left' ~ l_B11,
           Interval == 'Right' ~ r_B11,
           Interval == 'Mid' ~ m_B11,
           Interval == 'Sides' ~ s_B11,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_A7 = case_when(
           Interval == 'Left' ~ l_A7,
           Interval == 'Right' ~ r_A7,
           Interval == 'Mid' ~ m_A7,
           Interval == 'Sides' ~ s_A7,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_E5 = case_when(
           Interval == 'Left' ~ l_E5,
           Interval == 'Right' ~ r_E5,
           Interval == 'Mid' ~ m_E5,
           Interval == 'Sides' ~ s_E5,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(MaxArea = apply(select(., contains('area_')), 1, myMax)) %>%
  mutate(MinArea = apply(select(., contains('area_')), 1, myMin))


print(area_df, width = 400)
table(duplicated(area_df$Gene_id))
#+end_src
*** MinMax Normalization
#+BEGIN_SRC R :results none
#### Areas DF ####

## Import Areas table

a_pth <- '/mnt/Disc4T/Projects/PhD_Project/Microarrays/Join_Analysis/areas_maxmin_norm.tsv'
areas <- read_tsv(a_pth)

area_df_mmnorm <- areas %>%
  select(
    Gene_id,
    l_12B = `12B_Left_MaxMinNorm`,
    r_12B = `12B_Right_MaxMinNorm`,
    m_12B = `12B_Middle_MaxMinNorm`,
    s_12B = `12B_Sides_MaxMinNorm`,

    l_10G = `10G_Left_MaxMinNorm`,
    r_10G = `10G_Right_MaxMinNorm`,
    m_10G = `10G_Middle_MaxMinNorm`,
    s_10G = `10G_Sides_MaxMinNorm`,

    l_3D7B = `3D7B_Left_MaxMinNorm`,
    r_3D7B = `3D7B_Right_MaxMinNorm`,
    m_3D7B = `3D7B_Middle_MaxMinNorm`,
    s_3D7B = `3D7B_Sides_MaxMinNorm`,

    l_A7 = `A7_Left_MaxMinNorm`,
    r_A7 = `A7_Right_MaxMinNorm`,
    m_A7 = `A7_Middle_MaxMinNorm`,
    s_A7 = `A7_Sides_MaxMinNorm`,

    l_E5 = `E5_Left_MaxMinNorm`,
    r_E5 = `E5_Right_MaxMinNorm`,
    m_E5 = `E5_Middle_MaxMinNorm`,
    s_E5 = `E5_Sides_MaxMinNorm`,

    l_B11 = `B11_Left_MaxMinNorm`,
    r_B11 = `B11_Right_MaxMinNorm`,
    m_B11 = `B11_Middle_MaxMinNorm`,
    s_B11 = `B11_Sides_MaxMinNorm`,
    )

## Get Max and Min
print(area_df_mmnorm, width = 200)

area_df_mmnorm <- area_df_mmnorm %>%
  mutate(MaxLeft = apply(select(., contains('l_')), 1, myMax)) %>%
  mutate(MinLeft = apply(select(., contains('l_')), 1, myMin)) %>%

  mutate(MaxRight = apply(select(., contains('r_')), 1, myMax)) %>%
  mutate(MinRight = apply(select(., contains('r_')), 1, myMin)) %>%

  mutate(MaxMid = apply(select(., contains('m_')), 1, myMax)) %>%
  mutate(MinMid = apply(select(., contains('m_')), 1, myMin)) %>%

  mutate(MaxSides = apply(select(., contains('s_')), 1, myMax)) %>%
  mutate(MinSides = apply(select(., contains('s_')), 1, myMin)) %>%

  mutate(DifLeft = MaxLeft - MinLeft) %>%
  mutate(DifRight = MaxRight - MinRight) %>%
  mutate(DifMid = MaxMid - MinMid) %>%
  mutate(DifSides = MaxSides - MinSides)

print(area_df_mmnorm, width = 200)

## Add max interval and difference

timeint = (13.45+14.95)/2

maxinterval <- area_df_mmnorm %>%
  select(Gene_id, contains('Dif')) %>%
  pivot_longer(-Gene_id, names_to = 'Interval', values_to = 'MaxDif') %>%
  group_by(Gene_id) %>%
  filter(rank(-MaxDif, ties.method = "first") == 1) %>%
  mutate(Interval = ifelse(is.na(MaxDif), 'No Data', Interval)) %>%
  mutate(Interval = case_when(Interval == 'DifLeft' ~ 'Left',
                              Interval == 'DifRight' ~ 'Right',
                              Interval == 'DifMid' ~ 'Mid',
                              Interval == 'DifSides' ~ 'Sides',
                              Interval == 'No Data' ~ 'No Data')) %>%
  mutate(areaFC = MaxDif/timeint)

maxinterval

area_df_mmnorm <- area_df_mmnorm %>%
  left_join(maxinterval, by = 'Gene_id')

print(area_df_mmnorm, width = 400)

## Select appropiate area for each gene and add max and min areas

area_df_mmnorm <- area_df_mmnorm %>%
  mutate(area_12B = case_when(
           Interval == 'Left' ~ l_12B,
           Interval == 'Right' ~ r_12B,
           Interval == 'Mid' ~ m_12B,
           Interval == 'Sides' ~ s_12B,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_10G = case_when(
           Interval == 'Left' ~ l_10G,
           Interval == 'Right' ~ r_10G,
           Interval == 'Mid' ~ m_10G,
           Interval == 'Sides' ~ s_10G,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_3D7B = case_when(
           Interval == 'Left' ~ l_3D7B,
           Interval == 'Right' ~ r_3D7B,
           Interval == 'Mid' ~ m_3D7B,
           Interval == 'Sides' ~ s_3D7B,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_B11 = case_when(
           Interval == 'Left' ~ l_B11,
           Interval == 'Right' ~ r_B11,
           Interval == 'Mid' ~ m_B11,
           Interval == 'Sides' ~ s_B11,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_A7 = case_when(
           Interval == 'Left' ~ l_A7,
           Interval == 'Right' ~ r_A7,
           Interval == 'Mid' ~ m_A7,
           Interval == 'Sides' ~ s_A7,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_E5 = case_when(
           Interval == 'Left' ~ l_E5,
           Interval == 'Right' ~ r_E5,
           Interval == 'Mid' ~ m_E5,
           Interval == 'Sides' ~ s_E5,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(MaxArea = apply(select(., contains('area_')), 1, myMax)) %>%
  mutate(MinArea = apply(select(., contains('area_')), 1, myMin))


print(area_df_mmnorm, width = 400)
table(duplicated(area_df_mmnorm$Gene_id))

#+END_SRC
*** Z-score (stz) Normalitzation
#+begin_src R :results none
#### Areas DF ####

## Import Areas table

a_pth <- '/mnt/Disc4T/Projects/PhD_Project/Microarrays/Join_Analysis/areas_stz_norm.tsv'
areas <- read_tsv(a_pth)

area_df_stz <- areas %>%
  select(
    Gene_id,
    l_12B = `12B_Left_Stz`,
    r_12B = `12B_Right_Stz`,
    m_12B = `12B_Middle_Stz`,
    s_12B = `12B_Sides_Stz`,

    l_10G = `10G_Left_Stz`,
    r_10G = `10G_Right_Stz`,
    m_10G = `10G_Middle_Stz`,
    s_10G = `10G_Sides_Stz`,

    l_3D7B = `3D7B_Left_Stz`,
    r_3D7B = `3D7B_Right_Stz`,
    m_3D7B = `3D7B_Middle_Stz`,
    s_3D7B = `3D7B_Sides_Stz`,

    l_A7 = `A7_Left_Stz`,
    r_A7 = `A7_Right_Stz`,
    m_A7 = `A7_Middle_Stz`,
    s_A7 = `A7_Sides_Stz`,

    l_E5 = `E5_Left_Stz`,
    r_E5 = `E5_Right_Stz`,
    m_E5 = `E5_Middle_Stz`,
    s_E5 = `E5_Sides_Stz`,

    l_B11 = `B11_Left_Stz`,
    r_B11 = `B11_Right_Stz`,
    m_B11 = `B11_Middle_Stz`,
    s_B11 = `B11_Sides_Stz`,
    )

## Get Max and Min
print(area_df_stz, width = 200)

area_df_stz <- area_df_stz %>%
  mutate(MaxLeft = apply(select(., contains('l_')), 1, myMax)) %>%
  mutate(MinLeft = apply(select(., contains('l_')), 1, myMin)) %>%

  mutate(MaxRight = apply(select(., contains('r_')), 1, myMax)) %>%
  mutate(MinRight = apply(select(., contains('r_')), 1, myMin)) %>%

  mutate(MaxMid = apply(select(., contains('m_')), 1, myMax)) %>%
  mutate(MinMid = apply(select(., contains('m_')), 1, myMin)) %>%

  mutate(MaxSides = apply(select(., contains('s_')), 1, myMax)) %>%
  mutate(MinSides = apply(select(., contains('s_')), 1, myMin)) %>%

  mutate(DifLeft = MaxLeft - MinLeft) %>%
  mutate(DifRight = MaxRight - MinRight) %>%
  mutate(DifMid = MaxMid - MinMid) %>%
  mutate(DifSides = MaxSides - MinSides)

print(area_df_stz, width = 200)

## Add max interval and difference

timeint = (13.45+14.95)/2

maxinterval <- area_df_stz %>%
  select(Gene_id, contains('Dif')) %>%
  pivot_longer(-Gene_id, names_to = 'Interval', values_to = 'MaxDif') %>%
  group_by(Gene_id) %>%
  filter(rank(-MaxDif, ties.method = "first") == 1) %>%
  mutate(Interval = ifelse(is.na(MaxDif), 'No Data', Interval)) %>%
  mutate(Interval = case_when(Interval == 'DifLeft' ~ 'Left',
                              Interval == 'DifRight' ~ 'Right',
                              Interval == 'DifMid' ~ 'Mid',
                              Interval == 'DifSides' ~ 'Sides',
                              Interval == 'No Data' ~ 'No Data')) %>%
  mutate(areaFC = MaxDif/timeint)

maxinterval

area_df_stz <- area_df_stz %>%
  left_join(maxinterval, by = 'Gene_id')

print(area_df_stz, width = 400)

## Select appropiate area for each gene and add max and min areas

area_df_stz <- area_df_stz %>%
  mutate(area_12B = case_when(
           Interval == 'Left' ~ l_12B,
           Interval == 'Right' ~ r_12B,
           Interval == 'Mid' ~ m_12B,
           Interval == 'Sides' ~ s_12B,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_10G = case_when(
           Interval == 'Left' ~ l_10G,
           Interval == 'Right' ~ r_10G,
           Interval == 'Mid' ~ m_10G,
           Interval == 'Sides' ~ s_10G,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_3D7B = case_when(
           Interval == 'Left' ~ l_3D7B,
           Interval == 'Right' ~ r_3D7B,
           Interval == 'Mid' ~ m_3D7B,
           Interval == 'Sides' ~ s_3D7B,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_B11 = case_when(
           Interval == 'Left' ~ l_B11,
           Interval == 'Right' ~ r_B11,
           Interval == 'Mid' ~ m_B11,
           Interval == 'Sides' ~ s_B11,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_A7 = case_when(
           Interval == 'Left' ~ l_A7,
           Interval == 'Right' ~ r_A7,
           Interval == 'Mid' ~ m_A7,
           Interval == 'Sides' ~ s_A7,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(area_E5 = case_when(
           Interval == 'Left' ~ l_E5,
           Interval == 'Right' ~ r_E5,
           Interval == 'Mid' ~ m_E5,
           Interval == 'Sides' ~ s_E5,
           Interval == 'No Data' ~ NA_real_)) %>%
  mutate(MaxArea = apply(select(., contains('area_')), 1, myMax)) %>%
  mutate(MinArea = apply(select(., contains('area_')), 1, myMin))


print(area_df_stz, width = 400)
table(duplicated(area_df_stz$Gene_id))


#+end_src
** Load RNA-Seq Data

#+BEGIN_SRC R :results none
## #### Old approax ####
## Select max percentile directly

## otto <- read_delim("./Data/RNA_Seq_Percentiles/PlasmoDB_Otto.csv", delim=";") %>%
##   select(Gene_id = `Gene ID`, MaxPercOtto = `Max %ile (Within Chosen Samples)`)
## hoej <- read_delim("./Data/RNA_Seq_Percentiles/PlasmoDB_Hoejimakers.csv", delim=";") %>%
##   select(Gene_id = `Gene ID`, MaxPercHoej = `Max %ile (Within Chosen Samples)`)
## toen <- read_delim("./Data/RNA_Seq_Percentiles/PlasmoDB_Toenke.csv", delim=";") %>%
##   select(Gene_id = `Gene ID`, MaxPercToen = `Max %ile (Within Chosen Samples)`)
## bart <- read_delim("./Data/RNA_Seq_Percentiles/PlasmoDB_Bartfai.csv", delim=";") %>%
##   select(Gene_id = `Gene ID`, MaxPercBart = `Max %ile (Within Chosen Samples)`)


## Otto Data-Set

csv <- './Data/RNA_Seq_Percentiles/rnaseq_otto_normvals.csv'

otto <- read_delim(csv, delim=";") %>%
  select(Gene_id = `Gene ID`, contains('unique'))

otto <- otto %>%
  mutate(Max = apply(select(., contains('unique')), 1, myMax)) %>%
  mutate(Otto_Max_pcnt = (rank(Max)/length(Max))*100)

otto <- otto %>% select(Gene_id, Otto_Max_pcnt)
otto <- otto %>% group_by(Gene_id) %>% summarize_all(list(mean))

table(duplicated(otto$Gene_id))
otto %>% filter(duplicated(otto$Gene_id)) %>% print(width = 400)
otto %>% filter(Gene_id == 'PF3D7_0108400') %>% print(width = 400)

hist(otto$Otto_Max_pcnt)

## Hoeijmakers Data-Set

csv <- './Data/RNA_Seq_Percentiles/rnaseq_hoeijmakers_normvals.csv'

hoeij <- read_delim(csv, delim=";") %>%
  select(Gene_id = `Gene ID`, contains('scaled'))

hoeij <- hoeij %>%
  mutate(Max = apply(select(., contains('scaled')), 1, myMax)) %>%
  mutate(Hoeij_Max_pcnt = (rank(Max)/length(Max))*100)

hoeij <- hoeij %>% select(Gene_id, Hoeij_Max_pcnt)
hoeij <- hoeij %>% group_by(Gene_id) %>% summarize_all(list(mean))
hoeij

hist(hoeij$Hoeij_Max_pcnt)

## Toenhake Data-Sets

csv <- './Data/RNA_Seq_Percentiles/rnaseq_toen_normvals.csv'

toen <- read_delim(csv, delim=",") %>%
  select(Gene_id = `Gene ID`, contains('unique'))

toen <- toen %>%
  mutate(Max = apply(select(., contains('unique')), 1, myMax)) %>%
  mutate(Toen_Max_pcnt = (rank(Max)/length(Max))*100)

toen <- toen %>% select(Gene_id, Toen_Max_pcnt)
toen <- toen %>% group_by(Gene_id) %>% summarize_all(list(mean))

toen

hist(toen$Toen_Max_pcnt)

## Bartfai Data-Sets

csv <- './Data/RNA_Seq_Percentiles/rnaseq_bartfai_normvals.csv'

bart <- read_delim(csv, delim=",") %>%
  select(Gene_id = `Gene ID`, contains('scaled'))

bart <- bart %>%
  mutate(Max = apply(select(., contains('scaled')), 1, myMax)) %>%
  mutate(Bart_Max_pcnt = (rank(Max)/length(Max))*100)

bart <- bart %>% select(Gene_id, Bart_Max_pcnt)
bart <- bart %>% group_by(Gene_id) %>% summarize_all(list(mean))

bart

hist(bart$Bart_Max_pcnt)


## Join DF
rna_df <- otto %>%
  full_join(hoeij) %>%
  full_join(toen) %>%
  full_join(bart)

## Add mean and sd
rna_df <- rna_df %>%
  mutate(MeanPercent = apply(select(., -Gene_id), 1, mean)) %>%
  mutate(StdDevPercent = apply(select(., -Gene_id), 1, sd))


print(rna_df, width=200)

hist(rna_df$MeanPercent, breaks = 20)
hist(rna_df$StdDevPercent, breaks = 100)
table(duplicated(rna_df$Gene_id))
#+END_SRC
** Load Annotation
#+BEGIN_SRC R
## annot_df <- read_delim('./Data/plasmoDB_geneAnnot.csv', delim = ';') %>%
##   select(Gene_id = `Gene ID`,
##          Gene_name = `Gene Name or Symbol`,
##          Annot = `Product Description`) %>%
##   distinct() # remove duplicated rows

## print(annot_df, width=200)
## table(duplicated(annot_df$Gene_id))

annot_df <- read_csv('/mnt/Disc4T/Projects/PhD_Project/Binned_Coverage/info_df.csv')
#+END_SRC
** Create Join DF
#+BEGIN_SRC R :results none
print(red_df, width = 200)
print(area_df, width = 200)
print(rna_df, width = 200)

all_df <- select(red_df, Gene_id, contains('Percent'), MeanRedPercent) %>%
  full_join(select(area_df, Gene_id, Interval, contains('area')), by = 'Gene_id') %>%
  full_join(select(rna_df, Gene_id, MeanPercent), by = 'Gene_id')

all_df_mmnorm <- select(red_df, Gene_id, contains('Percent'), MeanRedPercent) %>%
  full_join(select(area_df_mmnorm, Gene_id, Interval, contains('area')), by = 'Gene_id') %>%
  full_join(select(rna_df, Gene_id, MeanPercent), by = 'Gene_id')

all_df_stz <- select(red_df, Gene_id, contains('Percent'), MeanRedPercent) %>%
  full_join(select(area_df_stz, Gene_id, Interval, contains('area')), by = 'Gene_id') %>%
  full_join(select(rna_df, Gene_id, MeanPercent), by = 'Gene_id')


## Add Vartiant Genes information

## cvg <- read_excel("./Data/CVG_list_jan2020_final.xlsx", sheet = "Final")

## final_df <- cvg %>%
##   select("Gene_id" = `Gene ID`, "Variant" = `Final Customized`) %>%
##   right_join(all_df, by = 'Gene_id') %>%
##   mutate(Variant = recode(Variant, YES = TRUE, NO = FALSE, .missing = FALSE))

## final_df_mmnorm <- cvg %>%
##   select("Gene_id" = `Gene ID`, "Variant" = `Final Customized`) %>%
##   right_join(all_df_mmnorm, by = 'Gene_id') %>%
##   mutate(Variant = recode(Variant, YES = TRUE, NO = FALSE, .missing = FALSE))

## final_df_stz <- cvg %>%
##   select("Gene_id" = `Gene ID`, "Variant" = `Final Customized`) %>%
##   right_join(all_df_stz, by = 'Gene_id') %>%
##   mutate(Variant = recode(Variant, YES = TRUE, NO = FALSE, .missing = FALSE))

## print(final_df, width = 200)
## print(final_df_mmnorm, width = 200)
## print(final_df_stz, width = 200)

## Here we create a dplyr function.
##To be able to use variables (for colnames) we needto use the special quote functions.
## Colnames to use inside functions must be "enquoted" before usage and preceded by !! when used.
## Colnames to assign must be "enquoted" first, preceded by !! and assigned by :=


## First create a col where we set categories for each gene according relative expression
## For each gene: gene-min----|---mid----|----gene-max

relexprs <- function(vect){
  if (any(is.na(vect))){
    return(NA)
  } else {
    labs = c('min', 'mid', 'max')
    lab <- cut(vect, 3, labels = labs)[1]
    return(as.character(lab))
  }
}

set_relexprs <- function(df, outcol, areacol){
  outcol <- enquo(outcol)
  areacol <- enquo(areacol)
  df %>%
    mutate(!! outcol := apply(select(., !! areacol, MaxArea, MinArea), 1, relexprs))
}

final_df <- all_df %>%
  set_relexprs(rel_12B, area_12B) %>%
  set_relexprs(rel_10G, area_10G) %>%
  set_relexprs(rel_3D7B, area_3D7B) %>%
  set_relexprs(rel_B11, area_B11) %>%
  set_relexprs(rel_A7, area_A7) %>%
  set_relexprs(rel_E5, area_E5)

final_df_mmnorm <- all_df_mmnorm %>%
  set_relexprs(rel_12B, area_12B) %>%
  set_relexprs(rel_10G, area_10G) %>%
  set_relexprs(rel_3D7B, area_3D7B) %>%
  set_relexprs(rel_B11, area_B11) %>%
  set_relexprs(rel_A7, area_A7) %>%
  set_relexprs(rel_E5, area_E5)

final_df_stz <- all_df_stz %>%
  set_relexprs(rel_12B, area_12B) %>%
  set_relexprs(rel_10G, area_10G) %>%
  set_relexprs(rel_3D7B, area_3D7B) %>%
  set_relexprs(rel_B11, area_B11) %>%
  set_relexprs(rel_A7, area_A7) %>%
  set_relexprs(rel_E5, area_E5)


## Add annotation
final_df <- left_join(final_df, annot_df, by = 'Gene_id')
final_df_mmnorm <- left_join(final_df_mmnorm, annot_df, by = 'Gene_id')
final_df_stz <- left_join(final_df_stz, annot_df, by = 'Gene_id')

print(final_df, width = 200)
print(final_df_mmnorm, width = 200)
print(final_df_stz, width = 200)

#+END_SRC
** Create Lists according to thresholds
#+BEGIN_SRC R
## Plot histograms of areaFC to decide treshold

p <- ggplot(final_df, aes(final_df$areaFC)) + geom_histogram()
ggsave('./Results_Tables_All_Strains/fc_hist.png', p)

p <- ggplot(final_df_mmnorm, aes(final_df_mmnorm$areaFC)) + geom_histogram()
ggsave('./Results_Tables_All_Strains/fc_mmnorm_hist.png', p)

p <- ggplot(final_df_stz, aes(final_df_stz$areaFC)) + geom_histogram()
ggsave('./Results_Tables_All_Strains/fc_stz_hist.png', p)

## Here we create a dplyr function.
##To be able to use variables (for colnames) we needto use the special quote functions.
## Colnames to use inside functions must be "enquoted" before usage and preceded by !! when used.
## Colnames to assign must be "enquoted" first, preceded by !! and assigned by :=

set_state <- function(df, statecol, redcol, relcol){

  statecol <- enquo(statecol)
  redcol <- enquo(redcol)
  relcol <- enquo(relcol)

  df <- df %>%
    mutate(!! statecol := case_when(
                ## Actiu
                !Variant &
                areaFC < th_areaFC &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent >= th_reddown ~ 'Active',

                !Variant &
                areaFC < th_areaFC &
                MeanPercent < th_rnapcnt &
                MeanRedPercent > th_redrescue ~ 'Active_rescued',

                ## Inactiu
                !Variant &
                areaFC < th_areaFC &
                MeanPercent < th_rnapcnt &
                MeanRedPercent < th_redrescue ~ 'Inactive',

                !Variant &
                areaFC < th_areaFC &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent < th_reddown ~ 'Inactive_reddown',

                ## No variant amb FC no RedPcntDif
                !Variant &
                areaFC > th_areaFC &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent >= th_reddown &
                MaxRedPercentDif < th_redpcntdif ~ 'Active_FC',

                !Variant &
                areaFC > th_areaFC &
                MeanPercent < th_rnapcnt &
                MeanRedPercent >= th_redrescue &
                MaxRedPercentDif < th_redpcntdif ~ 'Active_FC_rescued',

                !Variant &
                areaFC > th_areaFC &
                MeanPercent < th_rnapcnt &
                MeanRedPercent < th_redrescue &
                MaxRedPercentDif < th_redpcntdif ~ 'Inactive_FC',

                !Variant &
                areaFC > th_areaFC &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent < th_reddown &
                MaxRedPercentDif < th_redpcntdif ~ 'Inactive_FC_reddown',

                ## No variant amb FC i RedPcntDif
                ## RNA-Seq & MeanRed
                !Variant &
                areaFC > th_areaFC &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent >= th_reddown &
                MaxRedPercentDif >= th_redpcntdif &
                !! relcol == 'max' ~ 'Active_FC_Dif_max',

                !Variant &
                areaFC > th_areaFC &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent >= th_reddown &
                MaxRedPercentDif >= th_redpcntdif &
                !! relcol == 'mid' ~ 'Active_FC_Dif_mid',

                !Variant &
                areaFC > th_areaFC &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent >= th_reddown &
                MaxRedPercentDif >= th_redpcntdif &
                !! relcol == 'min' ~ 'Inactive_FC_Dif_min',

                ## RNA-Seq & NO-MeanRed
                !Variant &
                areaFC > th_areaFC &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent < th_reddown &
                MaxRedPercentDif >= th_redpcntdif &
                !! relcol == 'max' ~ 'Active_FC_Dif_reddown_max',

                !Variant &
                areaFC > th_areaFC &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent < th_reddown &
                MaxRedPercentDif >= th_redpcntdif &
                !! relcol == 'mid' ~ 'Active_FC_Dif_reddown_mid',

                !Variant &
                areaFC > th_areaFC &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent < th_reddown &
                MaxRedPercentDif >= th_redpcntdif &
                !! relcol == 'min' ~ 'Inactive_FC_Dif_reddown_min',

                ## NO-RNA-Seq Rescued
                !Variant &
                areaFC > th_areaFC &
                MeanPercent < th_rnapcnt &
                MeanRedPercent >= th_redrescue &
                MaxRedPercentDif >= th_redpcntdif &
                !! relcol == 'max' ~ 'Active_FC_Dif_rescued_max',

                !Variant &
                areaFC > th_areaFC &
                MeanPercent < th_rnapcnt &
                MeanRedPercent >= th_redrescue &
                MaxRedPercentDif >= th_redpcntdif &
                !! relcol == 'mid' ~ 'Active_FC_Dif_rescued_mid',

                !Variant &
                areaFC > th_areaFC &
                MeanPercent < th_rnapcnt &
                MeanRedPercent >= th_redrescue &
                MaxRedPercentDif >= th_redpcntdif &
                !! relcol == 'min' ~ 'Inactive_FC_Dif_rescued_min',

                ## NO-RNA-Seq NO-Rescued
                !Variant &
                areaFC > th_areaFC &
                MeanPercent < th_rnapcnt &
                MeanRedPercent < th_redrescue &
                MaxRedPercentDif >= th_redpcntdif &
                !! relcol == 'max' ~ 'Active_FC_Dif_noRNASeq_max',

                !Variant &
                areaFC > th_areaFC &
                MeanPercent < th_rnapcnt &
                MeanRedPercent < th_redrescue &
                MaxRedPercentDif >= th_redpcntdif &
                !! relcol == 'mid' ~ 'Active_FC_Dif_noRNASeq_mid',

                !Variant &
                areaFC > th_areaFC &
                MeanPercent < th_rnapcnt &
                MeanRedPercent < th_redrescue &
                MaxRedPercentDif >= th_redpcntdif &
                !! relcol == 'min' ~ 'Inactive_FC_Dif_noRNASeq_min',

                ## Var actiu
                Variant &
                areaFC < th_areaFC &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent >= th_reddown ~ 'Var_Active_noFC', # noFC

                Variant &
                areaFC < th_areaFC &
                MeanPercent < th_rnapcnt &
                MeanRedPercent >= th_redrescue ~ 'Var_Active_noFC_rescued', # noFC, rescued

                Variant &
                areaFC >= th_areaFC &
                !! redcol >= th_redpcnt &
                !! relcol == 'max' ~ 'Var_Active_FC', # Variant, FC, redpcnt, max

                Variant &
                areaFC >= th_areaFC &
                !! redcol >= th_redpcnt &
                !! relcol == 'mid' ~ 'Var_Semiactive_FC', # Variant, FC, redpcnt, mid

                ## Var repressed
                Variant &
                areaFC < th_areaFC &
                MeanPercent < th_rnapcnt &
                MeanRedPercent < th_redrescue ~ 'Var_Repressed_noFC', # noFC, noRescued

                Variant &
                areaFC < th_areaFC &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent < th_reddown ~ 'Var_Repressed_noFC_reddown', # noFC, downgraded


                Variant &
                areaFC >= th_areaFC &
                !! redcol >= th_redpcnt &
                !! relcol == 'min' ~ 'Var_Repressed_FC', # Variant, FC, redpcnt, min

                Variant &
                areaFC >= th_areaFC &
                !! redcol < th_redpcnt ~ 'Var_Repressed_FC_noredpcnt', # Variant, FC, NOredpcnt

                ###### Not settable

                ## FC NA
                !Variant &
                is.na(areaFC) &
                MeanPercent < th_rnapcnt &
                MeanRedPercent < th_redrescue ~ 'Inactive_FCna',

                !Variant &
                is.na(areaFC) &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent >= th_reddown ~ 'Active_FCna',

                !Variant &
                is.na(areaFC) &
                MeanPercent >= th_rnapcnt &
                is.na(MeanRedPercent) ~ 'Active_FCna_Redna',

                !Variant &
                is.na(areaFC) &
                MeanPercent < th_rnapcnt &
                is.na(MeanRedPercent) ~ 'Inactive_FCna_Redna',

                Variant &
                is.na(areaFC) &
                MeanPercent < th_rnapcnt &
                MeanRedPercent < th_redrescue ~ 'Var_Repressed_FCna',

                Variant &
                is.na(areaFC) &
                MeanPercent >= th_rnapcnt &
                MeanRedPercent >= th_reddown ~ 'Var_Active_FCna',

                ## RNA-Seq NA
                !Variant &
                is.na(MeanPercent) &
                areaFC < th_areaFC &
                MeanRedPercent >= th_redrescue ~ 'Active_RNASeqNA_rescue',

                !Variant &
                is.na(MeanPercent) &
                areaFC < th_areaFC &
                MeanRedPercent < th_reddown ~ 'Inactive_RNASeqNA_reddown',

                !Variant &
                is.na(MeanPercent) &
                areaFC >= th_areaFC &
                MeanRedPercent >= th_redrescue &
                !! relcol == 'max' ~ 'Active_RNASeqNA_rescue_FC_max',

                !Variant &
                is.na(MeanPercent) &
                areaFC >= th_areaFC &
                MeanRedPercent >= th_redrescue &
                !! relcol == 'mid' ~ 'Active_RNASeqNA_rescue_FC_mid',

                !Variant &
                is.na(MeanPercent) &
                areaFC >= th_areaFC &
                MeanRedPercent >= th_redrescue &
                !! relcol == 'min' ~ 'Inactive_RNASeqNA_rescue_FC_min',

                Variant &
                is.na(MeanPercent) &
                areaFC < th_areaFC &
                MeanRedPercent >= th_redrescue ~ 'Var_Active_RNASeqNA_rescue',

                Variant &
                is.na(MeanPercent) &
                areaFC < th_areaFC &
                MeanRedPercent < th_reddown ~ 'Var_Repressed_RNASeqNA_reddown',

                Variant &
                is.na(MeanPercent) &
                areaFC >= th_areaFC &
                MeanRedPercent >= th_redrescue &
                !! relcol == 'max' ~ 'Var_Active_RNASeqNA_rescue_FC_max',

                Variant &
                is.na(MeanPercent) &
                areaFC >= th_areaFC &
                MeanRedPercent >= th_redrescue &
                !! relcol == 'mid' ~ 'Var_Semiactive_RNASeqNA_rescue_FC_mid',

                Variant &
                is.na(MeanPercent) &
                areaFC >= th_areaFC &
                MeanRedPercent >= th_redrescue &
                !! relcol == 'min' ~ 'Var_Repressed_RNASeqNA_rescue_FC_min',


                TRUE ~ 'Not_Settable'))

  ## The 'TRUE ~ ...' handles rows that do not match any of previous patterns.
  ## Here we use it to make sure all rows are set (no "Wrong!" appearing)

  return(df)
}


set_category <- function(df, statecol, categorycol){

  statecol <- enquo(statecol)
  categorycol <- enquo(categorycol)

  df <- df %>%
    mutate(!! categorycol := case_when(
                !! statecol == 'Active' ~ 'Active',
                !! statecol == 'Inactive' ~ 'Inactive',
                !! statecol == 'Active_FC' ~ 'Active',
                !! statecol == 'Inactive_FC' ~ 'Inactive',

                !! statecol == 'Active_rescued' ~ 'Active',
                !! statecol == 'Inactive_reddown' ~ 'Inactive',
                !! statecol == 'Active_FC_rescued' ~ 'Active',
                !! statecol == 'Inactive_FC_reddown' ~ 'Inactive',

                !! statecol == 'Active_FC_Dif_max' ~ 'Active',
                !! statecol == 'Active_FC_Dif_mid' ~ 'Active',
                !! statecol == 'Inactive_FC_Dif_min' ~ 'Inactive',

                !! statecol == 'Active_FC_Dif_reddown_max' ~ 'Active',
                !! statecol == 'Active_FC_Dif_reddown_mid' ~ 'Active',
                !! statecol == 'Inactive_FC_Dif_reddown_min' ~ 'Inactive',

                !! statecol == 'Active_FC_Dif_rescue_max' ~ 'Active',
                !! statecol == 'Active_FC_Dif_rescue_mid' ~ 'Active',
                !! statecol == 'Inactive_FC_Dif_rescue_min' ~ 'Inactive',

                !! statecol == 'Active_FC_Dif_noRNASeq_max' ~ 'Active',
                !! statecol == 'Active_FC_Dif_noRNASeq_mid' ~ 'Active',
                !! statecol == 'Inactive_FC_Dif_noRNASeq_min' ~ 'Inactive',


                !! statecol == 'Var_Active_noFC' ~ 'Var_Active',
                !! statecol == 'Var_Active_noFC_rescued' ~ 'Var_Active',
                !! statecol == 'Var_Repressed_noFC' ~ 'Var_Repressed',
                !! statecol == 'Var_Repressed_noFC_reddown' ~ 'Var_Repressed',


                !! statecol == 'Var_Active_FC' ~ 'Var_Active',
                !! statecol == 'Var_Semiactive_FC' ~ 'Var_Semiactive',
                !! statecol == 'Var_Repressed_FC' ~ 'Var_Repressed',
                !! statecol == 'Var_Repressed_FC_noredpcnt' ~ 'Var_Repressed',

                !! statecol == 'Inactive_FCna' ~ 'Inactive',
                !! statecol == 'Active_FCna' ~ 'Active',
                !! statecol == 'Active_noVar_noMicroarray' ~ 'Active',

                ## With NAs
                !! statecol == 'Inactive_FCna' ~ 'Inactive',
                !! statecol == 'Active_FCna' ~ 'Active',
                !! statecol == 'Inactive_FCna_Redna' ~ 'Inactive',
                !! statecol == 'Active_FCna_Redna' ~ 'Active',

                !! statecol == 'Var_Repressed_FCna' ~ 'Var_Repressed',
                !! statecol == 'Var_Active_FCna' ~ 'Var_Active',

                !! statecol == 'Active_RNASeqNA_rescue' ~ 'Active',
                !! statecol == 'Inactive_RNASeqNA_reddown' ~ 'Inactive',

                !! statecol == 'Active_RNASeqNA_rescue_FC_max' ~ 'Active',
                !! statecol == 'Active_RNASeqNA_rescue_FC_mid' ~ 'Active',
                !! statecol == 'Inactive_RNASeqNA_rescue_FC_min' ~ 'Inactive',

                !! statecol == 'Var_Active_RNASeqNA_rescue' ~ 'Var_Active',
                !! statecol == 'Var_Repressed_RNASeqNA_reddown' ~ 'Var_Repressed',

                !! statecol == 'Var_Active_RNASeqNA_rescue_FC_max' ~ 'Var_Active',
                !! statecol == 'Var_Semiactive_RNASeqNA_rescue_FC_mid' ~ 'Var_Semiactive',
                !! statecol == 'Var_Repressed_RNASeqNA_rescue_FC_min' ~ 'Var_Repressed',

                TRUE ~ 'No_Category'))
  return(df)
}

## We now set each gene to it's state

## Thresolds

th_rnapcnt <- 25
th_redpcnt <- 25
th_redrescue <- 40
th_reddown <- 15
th_areaFC <- 1
th_redpcntdif <- 30

state_df <- final_df %>%
  set_state(state_12B, Percent_12B, rel_12B) %>%
  set_state(state_10G, Percent_10G, rel_10G) %>%
  set_state(state_3D7B, Percent_3D7B, rel_3D7B) %>%
  set_state(state_B11, Percent_B11, rel_B11) %>%
  set_state(state_A7, Percent_A7, rel_A7) %>%
  set_state(state_E5, Percent_E5, rel_E5) %>%
  set_category(state_12B, category_12B) %>%
  set_category(state_10G, category_10G) %>%
  set_category(state_3D7B, category_3D7B) %>%
  set_category(state_B11, category_B11) %>%
  set_category(state_A7, category_A7) %>%
  set_category(state_E5, category_E5)

## Save results
outname <- sprintf(
  './Results_Tables_All_Strains/state_df_rna%s_red%s_redresc%s_reddw%s_areaFC%s_redpcntdif%s_allstrains.csv',
  th_rnapcnt, th_redpcnt, th_redrescue, th_reddown, th_areaFC, th_redpcntdif
)
write.csv(state_df, outname)


## Thresolds

th_areaFC <- 0.01

state_df_mmnorm <- final_df_mmnorm %>%
  set_state(state_12B, Percent_12B, rel_12B) %>%
  set_state(state_10G, Percent_10G, rel_10G) %>%
  set_state(state_3D7B, Percent_3D7B, rel_3D7B) %>%
  set_state(state_B11, Percent_B11, rel_B11) %>%
  set_state(state_A7, Percent_A7, rel_A7) %>%
  set_state(state_E5, Percent_E5, rel_E5) %>%
  set_category(state_12B, category_12B) %>%
  set_category(state_10G, category_10G) %>%
  set_category(state_3D7B, category_3D7B) %>%
  set_category(state_B11, category_B11) %>%
  set_category(state_A7, category_A7) %>%
  set_category(state_E5, category_E5)

## Save results
outname <- sprintf(
  './Results_Tables_All_Strains/state_df_rna%s_red%s_redresc%s_reddw%s_areaFC%s_redpcntdif%s_allstrains_mmnorm.csv',
  th_rnapcnt, th_redpcnt, th_redrescue, th_reddown, th_areaFC, th_redpcntdif
)
write.csv(state_df_mmnorm, outname)

## Thresolds

th_areaFC <- 0.7

state_df_stz <- final_df_stz %>%
  set_state(state_12B, Percent_12B, rel_12B) %>%
  set_state(state_10G, Percent_10G, rel_10G) %>%
  set_state(state_3D7B, Percent_3D7B, rel_3D7B) %>%
  set_state(state_B11, Percent_B11, rel_B11) %>%
  set_state(state_A7, Percent_A7, rel_A7) %>%
  set_state(state_E5, Percent_E5, rel_E5) %>%
  set_category(state_12B, category_12B) %>%
  set_category(state_10G, category_10G) %>%
  set_category(state_3D7B, category_3D7B) %>%
  set_category(state_B11, category_B11) %>%
  set_category(state_A7, category_A7) %>%
  set_category(state_E5, category_E5)

print(state_df, width = 400)
table(state_df$state_12B)

state_df %>% filter(category_12B == 'No_Category!') %>% print(width = 400)

## Save results

outname <- sprintf(
  './Results_Tables_All_Strains/state_df_rna%s_red%s_redresc%s_reddw%s_areaFC%s_redpcntdif%s_allstrains_stz.csv',
  th_rnapcnt, th_redpcnt, th_redrescue, th_reddown, th_areaFC, th_redpcntdif
)
write.csv(state_df_stz, outname)
#+END_SRC
** Some checks and results
#+BEGIN_SRC R
## We check no rows are set to "Wrong!"
state_df %>%
  filter(state_12B == 'Not_Settable' |
         state_10G == 'Not_Settable' |
         state_3D7B == 'Not_Settable'|
         state_A7 == 'Not_Settable'|
         state_E5 == 'Not_Settable'|
         state_B11 == 'Not_Settable') %>%
  print(width = 400)

state_df %>%
  filter(category_12B == 'No_Category' |
         category_10G == 'No_Category' |
         category_3D7B == 'No_Category' |
         category_B11 == 'No_Category')


## ## Create a table with number of each state per strain
## state_table <-  bind_rows(table(state_df$state_12B),
##                           table(state_df$state_10G),
##                           table(state_df$state_3D7B),
##                           table(state_df$state_B11)) %>%
##   replace_na(list(Var_Semiactive = 0)) %>%
##   mutate(Strain = c('12B', '10G', '3D7B', 'B11')) %>%
##   select(Strain, everything())

## ## Create a table with differences between 12B and 10G
## dif12B_10G <- state_df %>%
##   filter(state_12B != state_10G) %>%
##   select(Gene_id, contains('12B'), contains('10G'), Gene_name, Annot)

## ## Check Clags
## clags <- state_df %>%
##   filter(Gene_id == 'PF3D7_0302500' | Gene_id == 'PF3D7_0302200')

## write.csv(clags, './Results_Tables_All_Strains_withB11/clag_genes.csv')

## print(state_table, width = 200)
## summary(rna_df)
#+END_SRC
